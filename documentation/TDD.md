# Technical Design Document (TDD) — Optional Rule Static Site

Reference: Product Requirements in `documentation/PRD.md`

This document captures the current technical architecture, data flows, and design decisions implemented in the repository. It also highlights inconsistencies and provides recommendations to streamline and refactor the codebase for sustainability, SOLID, and DRY improvements.


## 1. Scope, Goals, and Constraints

- Static, content‑focused site for Optional Rule Games built with Next.js App Router and exported as static files for GitHub Pages hosting.
- No server runtime or SSR in production; all routes are pre‑rendered (SSG) and exported to `out/`.
- Content authored in MDX within the repository.
- Discovery features: search (client‑side), tags, pagination; feeds: RSS and sitemap.
- An “Interactive” section houses client‑only features (Asteroids game).

See PRD sections “Purpose & Overview”, “Goals & Non‑Goals”, “System Architecture”, “Discovery & Feeds”, and “Interactive: Asteroids Game”.


## 2. High‑Level Architecture

- Framework: Next.js 15 App Router, static export (`output: 'export'`, `trailingSlash: true`).
  - Configuration: `next.config.ts:1`
- Route organization via route groups:
  - `(content)`: home, posts, tags, tag pages, pagination, search
  - `(pages)`: MDX static pages by slug
  - `(interactive)`: client‑only features
- Site‑wide layout and theme variables in `src/app/layout.tsx:1` with inline pre‑hydration theme script.
- Styling: Tailwind v4 tokens via CSS variables in `src/app/globals.css:1` with class‑based dark mode (`.dark`).
- Content pipeline (MDX + frontmatter) handled in `src/lib/content.ts:1` using `gray-matter`, a local `zod`‑style validator alias, and utilities in `src/lib/utils.ts:1`.
- Search pipeline: build‑time index generation to `public/search-index.json` + client‑side Fuse.js query in `src/lib/search.ts:1`.
- SEO helpers and JSON‑LD in `src/lib/seo.ts:1`; feeds in `src/lib/feeds.ts:1` with route handlers for sitemap and robots.
- Components in `src/components/*` with a11y and unit tests; MDX render components in `src/stories/mdx-components.tsx:1`.
- Tests: vitest + Testing Library + jest‑axe; targeted suites under `src/__tests__/`.


## 3. Repository and Module Map

- App Router (`src/app/`)
  - `layout.tsx`: root metadata + global shell (Header/Footer/GA) and theme injection.
  - `(content)`
    - Home: `src/app/(content)/page.tsx:1`
    - Pagination: `src/app/(content)/page/[page]/page.tsx:1` (static params, metadata)
    - Post page: `src/app/(content)/[year]/[month]/[day]/[slug]/page.tsx:1` (static params, date guard, MDX+ToC)
    - Tags index: `src/app/(content)/tags/page.tsx:1`
    - Tag page: `src/app/(content)/tag/[tag]/page.tsx:1` (static params, pagination)
    - Search: `src/app/(content)/search/page.tsx:1` (+ `layout.tsx:1` metadata)
  - `(pages)`
    - Static pages: `src/app/(pages)/pages/[slug]/page.tsx:1` (MDX+ToC)
  - `(interactive)`
    - Asteroids page: `src/app/(interactive)/games/asteroids/page.tsx:1` (+ client wrapper)
  - Static routes: `src/app/robots.txt/route.ts:1`, `src/app/sitemap.xml/route.ts:1`

- Libraries (`src/lib/`)
  - Content: `content.ts:1` (frontmatter schemas, drafts handling, pagination, tag queries)
  - Utilities: `utils.ts:1` (UTC date parsing, URL builders, slugs, excerpt, image paths)
  - SEO: `seo.ts:1` (metadata + JSON‑LD generation)
  - Search: `search.ts:1` (Fuse config/load/filter)
  - Feeds: `feeds.ts:1` (RSS, sitemap generators)
  - MDX: `mdx-options.ts:1`, `rehype-sanitize.ts:1`, `sanitize-schema.ts:1`
  - Types: `types.ts:1`; lightweight `zod` alias at `src/lib/zod.ts:1`

- Components (`src/components/`)
  - Navigation & Shell: `Header.tsx:1`, `Footer.tsx:1`, `GoogleAnalytics.tsx:1`
  - Content display: `PostCard.tsx:1`, `Pagination.tsx:1` (+ tests), `TableOfContents.tsx:1`
  - Search UI: `SearchInput.tsx:1`, `SearchResults.tsx:1`, `HighlightedText.tsx:1`
  - MDX helpers: `HeadingAnchor.tsx:1`, `MarkdownLink.tsx:1`, `SmartLink.tsx:1`, media embeds

- Features (`src/features/games/asteroids/`)
  - Entrypoint: `index.tsx:1`; configuration: `config.ts:1`; constants mapping: `constants.ts:1`; types: `types.ts:1`
  - Note: Referenced `components/*` and `hooks/*` are not present (see Inconsistencies).

- Scripts (`scripts/`)
  - Search index: `generate-search-index.ts:1`
  - Feeds: `generate-rss.ts:1`
  - Content helpers: `create-post.ts`, `find-empty-links.ts`, `download-external-images.ts`, `replace-default-images.ts`


## 4. Routing, SSG, and URL Semantics

- Static Export: `next.config.ts:1` enforces `output: 'export'` and `trailingSlash: true` for GitHub Pages.
- Post URLs: `/:year/:month/:day/:slug/` generated by `generatePostUrl` in `src/lib/utils.ts:1` and validated in the post page.
- Pagination: `/page/:n/` where `n ≥ 2`. Static params are computed based on post count.
- Tags: `/tags/` for index; `/tag/:slug/` for tag pages; supports pagination model in UI.
- Search: `/search/` driven by `?q=` parameter.
- Static routes: `sitemap.xml` and `robots.txt` via route handlers marked `dynamic = 'force-static'`.


## 5. Data Models and Content Pipeline

- Frontmatter schemas defined in `src/lib/content.ts:1` using a minimal local `zod` alias (`src/lib/zod.ts:1`) to avoid runtime deps:
  - Post frontmatter: title, date, excerpt?, tags?, featured_image?, slug?, draft?, showToc?
  - Page frontmatter: title, description?, draft?, showToc?
- Content functions:
  - `getPostFiles`, `getAllPostFiles`: MDX discovery with draft filtering in production.
  - `getPostMeta`, `getAllPostsMeta`, `getPaginatedPosts`: list views and pagination.
  - `getPost(slug)`: full post content + headings + reading time.
  - `getAllTags`, `getPostsByTag(tag, page)`: tag processing with slug↔name utilities.
  - `getPage(slug)`, `getAllPageSlugs`: static pages content.
- Utilities (`src/lib/utils.ts:1`):
  - UTC date parsing (`parseDateToUTC`), URL generation (`generatePostUrl`), tag slugging, excerpt generation, image path normalization.


## 6. MDX Rendering and Sanitization

- Rendering: `next-mdx-remote/rsc` in post and page routes.
- Components: override mapping in `src/stories/mdx-components.tsx:1` provides consistent headings with anchors, link handling, images, lists, tables, code blocks, etc. Images fall back to `<img>` when dimensions are missing to avoid Next/Image requirements during export.
- Sanitization: custom `rehype-sanitize` plugin (`src/lib/rehype-sanitize.ts:1`) with an allow‑list schema (`src/lib/sanitize-schema.ts:1`).
  - Drops disallowed tags (e.g., `script`) and any `on*` handlers.
  - Allows select attributes (`href`, `alt`, `className`, etc.).


## 7. Search Pipeline (Client‑side)

- Index generation at build time: `scripts/generate-search-index.ts:1`
  - Reads MDX posts, applies post frontmatter schema, computes reading time and excerpts.
  - Writes `public/search-index.json` for client‑side consumption.
- Client query: `src/lib/search.ts:1` using Fuse.js
  - Keys: title (0.7), excerpt (0.2), tags (0.1); `ignoreLocation: true`; `findAllMatches: true`.
  - Loader validates JSON shape before initializing Fuse.
- UI: `SearchInput.tsx:1` (debounced input + URL param sync) and `SearchResults.tsx:1` (loading + results + no results states, highlights via `HighlightedText`).


## 8. SEO, Metadata, and Feeds

- Page metadata: `src/lib/seo.ts:1` with helpers
  - `generateMetadata` for generic pages; `generatePostMetadata` for posts; `generateHomeMetadata`, tag and pagination variants; JSON‑LD for posts/home/site.
  - `src/app/layout.tsx:1` sets site‑wide metadata template and icons, and computes theme CSS variables.
- Feeds: `src/lib/feeds.ts:1` provides RSS and sitemap output from content models.
  - SSG route handlers: `src/app/sitemap.xml/route.ts:1` uses `generateSitemap()`.
  - Build scripts: `scripts/generate-rss.ts:1` generates `public/rss.xml` and `public/sitemap.xml` for convenience.


## 9. Theming and Styles

- CSS variables for light/dark defined in `src/app/globals.css:1`.
- Class‑based dark mode toggled by `.dark` on `<html>`.
- Pre‑hydration script in `src/app/layout.tsx:1` applies saved preference or default (`siteConfig.defaultTheme`).
- Tailwind v4 inlined via `@theme inline` tokens mapping CSS variables into Tailwind utilities.


## 10. Interactive Features (Asteroids)

- Route: `src/app/(interactive)/games/asteroids/page.tsx:1` dynamically imports a client component wrapper (`AsteroidsGameClient.tsx:1`) and the feature entry `src/features/games/asteroids/index.tsx:1` with `ssr: false`.
- Configuration: `src/features/games/asteroids/config.ts:1` centralizes gameplay, physics, rendering constants.
- Types: `src/features/games/asteroids/types.ts:1` define entities, game state, and config interfaces.
- Note: Referenced submodules (`./components/GameCanvas`, `./components/GameUI`, `./hooks/useAsteroids`) are not present in this repo snapshot; see Risks/Recommendations.


## 11. Security and Privacy

- Static‑only deployment; no runtime APIs.
- MDX sanitization (rehype plugin) removes dangerous tags/attrs.
- `SmartLink.tsx:1` enforces `noopener noreferrer` on external links.
- Analytics via `GoogleAnalytics.tsx:1` with ID from `src/config/site.ts:1`.
- CSP: The PRD references strict CSP/nonce usage; current layout includes an inline script for theme only.


## 12. Testing

- Unit and integration tests (vitest + Testing Library + jest‑axe).
  - Accessibility: `src/__tests__/accessibility.test.tsx:1`
  - Static generation, URL semantics, metadata, image paths: `src/__tests__/ssg.test.ts:1`
  - Content/search pipeline, pagination, draft filtering: `src/__tests__/integration.test.ts:1`
  - MDX sanitization: `src/__tests__/mdx-sanitize.test.ts:1` and `src/__tests__/mdx-remote.test.tsx:1`
- Test setup mocks Next.js primitives in `src/test-setup.ts:1`.


## 13. Build and Operations

- Scripts: `npm run build` runs `generate-search-index` and `generate-rss` before `next build`.
- Static output in `out/`; optional verifier `scripts/verify-titles.js:1`.
- GitHub Pages hosting; `trailingSlash: true` required; `images.unoptimized: true`.


## 14. Design Decisions and Rationale

- Static export with content in repo simplifies hosting and avoids server dependencies.
- Local `zod` alias avoids bundling a heavy runtime dependency while preserving schema‑driven parsing semantics.
- Client‑side search avoids server APIs; a prebuilt JSON index keeps bundles small and search fast.
- MDX rendering with a narrow sanitization allow‑list balances author flexibility with safety.
- Class‑based theme toggle with a pre‑hydrate script removes FOUC and respects preferences.
- Interactive features are isolated under `(interactive)` and loaded client‑side with `dynamic(..., { ssr: false })`.


## 15. Inconsistencies and Risks

- Robots sitemap URL hard‑coded: `src/app/robots.txt/route.ts:1` uses `https://yourdomain.github.io/sitemap.xml` instead of `siteConfig.url`.
- Trailing slash inconsistencies in links: some internal links use `/search` vs `/search/` (e.g., `Header.tsx:1`, `SearchInput.tsx:1`). With `trailingSlash: true` this may cause client redirects.
- Pagination page size duplicated: `10` is hard‑coded in multiple view files (`tags/page.tsx:1`, `test-pagination/page.tsx:1`) instead of a shared constant.
- Search UX text vs implementation: UI copy says “title, content, or tags”, but the Fuse config searches only title/excerpt/tags and the index’s `content` is intentionally empty. This mismatch can confuse users.
- Feed generation duplication: `scripts/generate-rss.ts:1` contains an embedded copy of site settings and feed logic rather than reusing `src/config/site.ts:1` and `src/lib/feeds.ts:1`.
- Asteroids feature incomplete: `src/features/games/asteroids/index.tsx:1` imports `GameCanvas`, `GameUI`, and `useAsteroids` that are not present; the page route will fail to build if included in an export. The PRD assumes these exist.
- `public/CNAME` content appears to include a leading `;` which is not a valid GitHub Pages CNAME file format.


## 16. Recommendations (SOLID, DRY, Sustainability)

- Centralize URL and host references
  - Provide a helper `siteUrl()` that reads from `siteConfig.url` and ensure robots/sitemap/feeds reference it.
  - Replace hard‑coded robots sitemap URL with `siteConfig.url`.

- Normalize internal URL generation
  - Introduce a small `urlPaths` helper: `home()`, `search()`, `tags()`, `post(date, slug)`, `tag(slug, page?)`, `page(n)`.
  - Update components and pages to use helpers to enforce trailing slashes and avoid redirects.

- Single source of truth for pagination
  - Export `POSTS_PER_PAGE` from `src/lib/content.ts:1` (already defined) and import it in UI pages (`tags/page.tsx`, demo pages) to remove magic numbers.

- Align search UX and implementation
  - Update UI copy to “title, excerpt, or tags” or extend the index to include a truncated, sanitized body snippet and add `'content'` to Fuse keys at a low weight (e.g., 0.05‑0.1).
  - If including content, keep size in check (e.g., store first N chars of sanitized plain text).

- De‑duplicate feed generation
  - Change `scripts/generate-rss.ts` to import `siteConfig` and `generateRSSFeed` / `generateSitemap` from `src/lib/feeds.ts:1` (scripts already run with `tsx` ESM loader). Remove in‑script copies.

- Complete or gate the Asteroids feature
  - Option A: Add the missing `components/` and `hooks/` modules to match the PRD; ensure the route builds under static export.
  - Option B: Gate the route behind a feature flag and render a “Coming Soon” placeholder until complete to avoid build failures.

- Improve config consistency
  - Validate `public/CNAME` contains the exact custom domain (no punctuation) if GitHub Pages uses a CNAME.
  - Ensure `siteConfig.url` matches the canonical production URL and is used everywhere (feeds, JSON‑LD, robots, sitemap).

- Minor code structure cleanup
  - Factor `Header` into smaller subcomponents; remove inline SVG duplication where reasonable.
  - Extract simple UI constants (nav items, utility items) to config for easier updates and tests.
  - Consider moving sitemap and robots route content generation into `lib/feeds.ts` (thin route handlers) for parity.

- Testing enhancements
  - Add a focused test to assert robots content uses `siteConfig.url`.
  - Add a test to ensure internal links render with trailing slashes.
  - Add smoke tests to verify `generateStaticParams` for posts/tags do not regress.


## 17. Improvement Plan (Phased)

Phase 1 — Correctness and DRY
- Fix robots sitemap URL to use `siteConfig.url`.
- Replace internal links to consistently include trailing slashes or route through helpers.
- Export `POSTS_PER_PAGE` from `lib/content` and consume in all UI pages.
- Update search UX copy or include basic content snippets in the index and Fuse keys.
- Update `scripts/generate-rss.ts` to import from `src/lib/feeds.ts` and `src/config/site.ts`.

Phase 2 — Feature Completion and Structure
- Implement or gate Asteroids submodules to ensure static export passes.
- Extract `Header`/nav config and reduce duplication of icons and menu items.
- Move sitemap/robots string building to shared functions; keep route handlers thin.

Phase 3 — Quality and Hardening
- Add tests for robots/sitemap correctness; add link normalization tests.
- Consider a content linter rule for frontmatter and image paths.
- Review CSP needs and incorporate nonce handling consistently if required by analytics.


## 18. Operational Notes

- Commands
  - Dev: `npm run dev`
  - Build: `npm run build` (generates search index + RSS, then Next export)
  - Serve prod: `npm start`
  - Lint/tests/storybook: see `package.json:1`
- Static hosting constraints
  - No Next Image optimization API; whitelist remote hosts only if needed.
  - Trailing slashes required for GitHub Pages path semantics.


## 19. Traceability to PRD

- Architecture, routing, and static export align with PRD Sections 2, 4, 6, 7, 10, 11, 13.
- Search weights match PRD (title/excerpt/tags), though content searching is not enabled; recommendation included.
- Interactive/Asteroids route and config match PRD expectations but code is incomplete; recommendation included.
- Feeds (RSS, sitemap), analytics, and a11y expectations are implemented with tests.


---
This TDD reflects the repository state at the time of writing and is intended to guide incremental improvements that preserve the site’s static export model while increasing maintainability and correctness.

## 20. Quick Fixes Applied (This Revision)

- Robots sitemap URL now uses `siteConfig.url` in `src/app/robots.txt/route.ts`.
- Internal search links normalized to include trailing slashes:
  - `src/components/Header.tsx` utility link → `/search/`
  - `src/components/SearchInput.tsx` navigation now pushes `/search/?q=...` and clears to `/search/`
  - Updated tests in `src/components/__tests__/SearchInput.test.tsx` accordingly.
- Centralized pagination constant by exporting `POSTS_PER_PAGE` from `src/lib/content.ts` and reusing in:
  - `src/app/(content)/tags/page.tsx`
  - `src/app/(content)/tag/[tag]/page.tsx`
  - `src/app/(content)/test-pagination/page.tsx`
- Search UX copy aligned with implementation (title, excerpt, tags) in:
  - `src/app/(content)/search/page.tsx`
  - `src/app/(content)/search/layout.tsx`
- Feed script refactored to reuse shared logic/config:
  - `scripts/generate-rss.ts` now imports from `src/lib/feeds.ts` instead of duplicating logic and config.
- CNAME corrected for GitHub Pages:
  - `public/CNAME` now contains `www.optionalrule.com` without extraneous characters.
